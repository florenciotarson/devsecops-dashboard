name: DevSecOps Security Scan

on: [push, pull_request]

jobs:
  security:
    name: Run Security Scans
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Semgrep (Static Code Analysis)
        run: |
          pip install semgrep
          semgrep scan --config=auto

      - name: Run Trivy (Dependency Scan)
        run: |
          # Install Trivy into ./bin
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ./bin
          # Call Trivy explicitly from ./bin
          ./bin/trivy fs .

      - name: Run Checkov (Terraform Security Scan)
        run: |
          # Ensure infra folder exists so Checkov doesn't complain
          mkdir -p infra
          pip install checkov
          checkov -d infra/

      - name: Run Prowler (AWS Security Audit)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # Remove any leftover folder
          rm -rf prowler-repo
          # Clone fresh
          git clone https://github.com/prowler-cloud/prowler.git prowler-repo
          cd prowler-repo
          
          # List files for debugging
          echo "=== Debugging: Contents of prowler-repo ==="
          ls -al
          
          # If there's a script named 'prowler' in this folder, rename it
          # to avoid conflict with any directory also named 'prowler'.
          if [ -f prowler ]; then
            echo "Found prowler script."
            mv prowler prowler_script
            chmod +x prowler_script
            echo "=== Debugging: After renaming prowler to prowler_script ==="
            ls -al
            # Run prowler with a new name
            bash ./prowler_script -M json -o prowler-report.json
          else
            echo "ERROR: Did not find a prowler script file. Listing files again:"
            ls -al
            exit 1
          fi

      - name: Run ScoutSuite (AWS Security Report)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          pip install scoutsuite
          scoutsuite -p aws --report scoutsuite-report

      - name: Upload Security Reports as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            prowler-repo/prowler-report.json
            scoutsuite-report
